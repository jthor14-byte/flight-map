<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flight Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Turf.js for great-circle paths -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #sidebar { padding: 14px 14px 10px; border-right: 1px solid #e6e6e6; overflow: auto; }
    #map { height: 100%; }

    h1 { font-size: 18px; margin: 0 0 10px; }
    .row { margin: 10px 0; }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 6px; }
    select, input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
    }
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .card {
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 10px;
    }
    .card .k { font-size: 11px; color: #666; }
    .card .v { font-size: 18px; font-weight: 650; margin-top: 4px; }
    .small { font-size: 12px; color: #666; margin-top: 10px; line-height: 1.35; }
    .error { color: #b00020; font-size: 13px; white-space: pre-wrap; }
    .btnrow { display: flex; gap: 10px; margin-top: 10px; }
    button {
      flex: 1;
      border: 1px solid #ddd;
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: #fafafa; }
    .route-arrow {
  font-size: 14px;
  font-weight: 800;
  line-height: 14px;
  text-shadow: 0 0 2px white, 0 0 2px white;
}
  </style>
</head>

<body>
  <div id="app">
    <div id="sidebar">
      <h1>Flight Map</h1>

      <div class="row">
        <label>Google Sheets CSV URL</label>
        <input id="csvUrl" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQuPdIajrcLWbRa2toJZUhscpdP-b2QaxzlkWvsCxcDu2r67cPXZyWmQmyIZdFxaQ/pub?gid=146220048&single=true&output=csv" />
        <div class="btnrow">
          <button id="loadBtn">Load</button>
          <button id="resetBtn">Reset view</button>
        </div>
      </div>

      <div class="row">
        <label>Year (defaults to latest)</label>
        <select id="yearSelect" disabled></select>
      </div>

      <div class="row">
        <label>Airline</label>
        <select id="airlineSelect" disabled></select>
      </div>

      <div class="stats">
  <div class="card"><div class="k">Flights</div><div class="v" id="sFlights">‚Äì</div></div>
  <div class="card"><div class="k">Distance (km)</div><div class="v" id="sKm">‚Äì</div></div>
  <div class="card"><div class="k">Est. hours</div><div class="v" id="sHours">‚Äì</div></div>
  <div class="card"><div class="k">Top route</div><div class="v" id="sTopRoute">‚Äì</div></div>
        <div class="card"><div class="k">Est. days (in air)</div><div class="v" id="sDays">‚Äì</div></div>
        <div class="card"><div class="k">Top airline (flights)</div><div class="v" id="sTopAirlineFlights">‚Äì</div></div>
<div class="card"><div class="k">Top airline (km)</div><div class="v" id="sTopAirlineKm">‚Äì</div></div>

  <div class="card"><div class="k">Airports visited</div><div class="v" id="sAirports">‚Äì</div></div>
  <div class="card"><div class="k">Most visited airport</div><div class="v" id="sTopAirport">‚Äì</div></div>
<div class="card"><div class="k">Est. time at airport (hrs)</div><div class="v" id="sAirportHours">‚Äì</div></div>
</div>
      <div id="err" class="row error"></div>
      <div class="row">
  <label>Airport</label>
  <select id="airportSelect" disabled></select>
</div>
      <div class="row">
  <label style="display:flex; align-items:center; gap:10px;">
    <input id="airportsOnlyToggle" type="checkbox" style="width:auto; transform:scale(1.1);" />
    Airports only (no routes / arrows)
  </label>
</div>
      <div class="row">
  <label>Top 5 months (distance)</label>
  <div id="topMonths" style="font-size:12px; color:#444; line-height:1.5;">‚Äì</div>
</div>
      <div class="row">
  <label>Countries visited (filtered)</label>
  <div id="flags" style="font-size: 22px; line-height: 28px; word-wrap: break-word;"></div>
</div>
<div class="row" style="margin-top: 14px;">
  <label>Distance comparisons</label>

  <div style="margin-top: 8px;">
    <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:6px;">
      <span>üåç Earth ‚Üí üåï Moon</span>
      <span id="moonText">‚Äì</span>
    </div>
    <div style="position:relative; height:14px; border:1px solid #eee; border-radius:999px; overflow:hidden;">
      <div id="moonBar" style="height:100%; width:0%; background:#ddd;"></div>
      <div id="moonPlane" style="position:absolute; top:-6px; left:0%; transform:translateX(-50%); font-size:18px;">‚úàÔ∏è</div>
    </div>
  </div>
  <div style="margin-top: 12px;">
  <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:6px;">
    <span>üåç Earth ‚Üí ‚ôÇÔ∏è Mars</span>
    <span id="marsText">‚Äì</span>
  </div>
  <div style="position:relative; height:14px; border:1px solid #eee; border-radius:999px; overflow:hidden;">
    <div id="marsBar" style="height:100%; width:0%; background:#ddd;"></div>
    <div id="marsPlane" style="position:absolute; top:-6px; left:0%; transform:translateX(-50%); font-size:18px;">‚úàÔ∏è</div>
  </div>
</div>

  <div style="margin-top: 12px;">
    <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:6px;">
      <span>üåç Around the world</span>
      <span id="worldText">‚Äì</span>
    </div>
    <div style="position:relative; height:14px; border:1px solid #eee; border-radius:999px; overflow:hidden;">
      <div id="worldBar" style="height:100%; width:0%; background:#ddd;"></div>
      <div id="worldPlane" style="position:absolute; top:-6px; left:0%; transform:translateX(-50%); font-size:18px;">‚úàÔ∏è</div>
    </div>
  </div>
</div>
      <div class="small">
        Notes:
        <ul>
          <li>Uses your sheet‚Äôs <code>from_lat/from_lng</code> and <code>to_lat/to_lng</code> columns.</li>
          <li>Routes are drawn as great-circle lines (approx) using Turf.</li>
          <li>If you open this file directly (file://), some browsers block fetch. Use a simple local server or GitHub Pages.</li>
        </ul>
      </div>
    </div>

    <div id="map"></div>
  </div>

<script>
  // ---------- Map setup ----------
  const map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 8,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

 const routeLayer = L.layerGroup().addTo(map);
const markerLayer = L.layerGroup().addTo(map);   // airports
const arrowLayer  = L.layerGroup().addTo(map);   // arrows

  // ---------- Helpers ----------
  const normKey = (s) => (s ?? '').toString().trim().toLowerCase();
  const num = (x) => {
    const n = Number((x ?? '').toString().trim());
    return Number.isFinite(n) ? n : null;
  };
  const parseYear = (dateStr) => {
    // expects YYYY-MM-DD or ISO-ish
    const s = (dateStr ?? '').toString().trim();
    const m = s.match(/^(\d{4})/);
    return m ? Number(m[1]) : null;
  };
  const fmt = (n) => new Intl.NumberFormat().format(n);
  const AVG_AIRPORT_HOURS_PER_MENTION = 2.5;
  const MOON_DISTANCE_KM = 384400;   // mean Earth‚ÄìMoon distance
  const MARS_DISTANCE_KM = 54000000; // ~shortest Earth‚ÄìMars distance (very approximate)
const EARTH_CIRC_KM = 40075;       // Earth's circumference (approx)

 function clearLayers() {
  routeLayer.clearLayers();
  markerLayer.clearLayers();
  arrowLayer.clearLayers();
}

  function setError(msg) {
    document.getElementById('err').textContent = msg || '';
  }

  function resetView() {
    map.setView([20, 0], 2);
  }

  function getColorForAirline(name) {
    // deterministic-ish without picking explicit colors:
    // Leaflet will use default polyline color if we omit; but to visually separate airlines,
    // we derive a hue and use HSL. If you‚Äôd rather avoid colors entirely, set `return null;`
    if (!name) return null;
    let h = 0;
    for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) >>> 0;
    const hue = h % 360;
    return `hsl(${hue} 65% 45%)`;
  }

  function greatCircleSegments(fromLat, fromLng, toLat, toLng) {
  const start = turf.point([fromLng, fromLat]);
  const end   = turf.point([toLng, toLat]);

  const gc = turf.greatCircle(start, end, {
    npoints: 100,
    properties: {},
    antimeridian: true
  });

  // Turf may return LineString OR MultiLineString when crossing the date line
  const geom = gc.geometry;
  const lines = (geom.type === "MultiLineString")
    ? geom.coordinates
    : [geom.coordinates];

  // Convert each segment into Leaflet [lat,lng] points
  return lines.map(line => line.map(([lng, lat]) => [lat, lng]));
}

  function computeTopRoute(rows) {
    const counts = new Map();
    for (const r of rows) {
      const route = r.route || `${r.from_iata || ''}‚Äì${r.to_iata || ''}`;
      if (!route.trim()) continue;
      counts.set(route, (counts.get(route) || 0) + 1);
    }
    let best = null, bestN = 0;
    for (const [k, v] of counts.entries()) {
      if (v > bestN) { best = k; bestN = v; }
    }
    return best ? `${best} (${bestN})` : '‚Äì';
  }
function computeUniqueAirports(rows) {
  const s = new Set();
  for (const r of rows) {
    if (r.from_iata) s.add(r.from_iata);
    if (r.to_iata) s.add(r.to_iata);
  }
  return s.size;
}
function computeAirportMentions(rows, airport) {
  let mentions = 0;
  for (const r of rows) {
    if (!airport) {
      if (r.from_iata) mentions += 1;               // departures only
    } else {
      if (r.from_iata === airport) mentions += 1;   // departures only
    }
  }
  return mentions;
}
function computeTopAirport(rows) {
  // Count each airport at most once per date
  const counts = new Map();           // airport -> number of days it appears
  const seenPerDay = new Set();       // `${date}|${airport}`

  for (const r of rows) {
    const date = (r.date || '').trim();
    if (!date) continue;

    const airports = [];
    if (r.from_iata) airports.push(r.from_iata);
    if (r.to_iata) airports.push(r.to_iata);

    for (const a of airports) {
      const airport = (a || '').trim().toUpperCase();
      if (!airport) continue;

      const key = `${date}|${airport}`;
      if (seenPerDay.has(key)) continue;

      seenPerDay.add(key);
      counts.set(airport, (counts.get(airport) || 0) + 1);
    }
  }

  let best = null, bestN = 0;
  for (const [k, v] of counts.entries()) {
    if (v > bestN) { best = k; bestN = v; }
  }

  return best ? `${best} (${bestN})` : '‚Äì';
}
  function addArrowAtMidpoint(latlngs, color) {
  if (!latlngs || latlngs.length < 3) return;

  const mid = Math.floor(latlngs.length / 2);
  const prev = latlngs[mid - 1];
  const curr = latlngs[mid];
  const next = latlngs[mid + 1];

  // Direction based on local segment
  const dy = next[0] - prev[0];
  const dx = next[1] - prev[1];
  const angle = Math.atan2(dy, dx) * (180 / Math.PI);

  const html = `
    <div class="route-arrow"
         style="color:${color || '#1f78b4'};
                transform: translate(-7px, -7px) rotate(${angle}deg);">
      ‚û§
    </div>
  `;

  const icon = L.divIcon({
    className: '',
    html,
    iconSize: [14, 14],
    iconAnchor: [7, 7]
  });
L.marker(curr, { icon, interactive: false }).addTo(arrowLayer);
}
  function iso2ToFlagEmoji(code) {
  const c = (code || '').trim().toUpperCase();
  if (!/^[A-Z]{2}$/.test(c)) return '';
  const base = 0x1F1E6;
  return String.fromCodePoint(
    base + (c.charCodeAt(0) - 65),
    base + (c.charCodeAt(1) - 65)
  );
}

function computeCountryFlags(rows) {
  const set = new Set();
  for (const r of rows) {
    if (r.from_country_code) set.add(r.from_country_code);
    if (r.to_country_code) set.add(r.to_country_code);
  }
  return Array.from(set)
    .filter(Boolean)
    .sort((a, b) => a.localeCompare(b))
    .map(iso2ToFlagEmoji)
    .filter(Boolean);
}
  function computeTopAirlineByFlights(rows) {
  const counts = new Map();
  for (const r of rows) {
    const a = (r.airline || '').trim();
    if (!a) continue;
    counts.set(a, (counts.get(a) || 0) + 1);
  }
  let best = null, bestN = 0;
  for (const [k, v] of counts.entries()) {
    if (v > bestN) { best = k; bestN = v; }
  }
  return best ? `${best} (${bestN})` : '‚Äì';
}

function computeTopAirlineByKm(rows) {
  const sums = new Map();
  for (const r of rows) {
    const a = (r.airline || '').trim();
    if (!a) continue;
    sums.set(a, (sums.get(a) || 0) + (r.distance_km || 0));
  }
  let best = null, bestKm = 0;
  for (const [k, v] of sums.entries()) {
    if (v > bestKm) { best = k; bestKm = v; }
  }
  return best ? `${best} (${Math.round(bestKm)})` : '‚Äì';
}
function updateDistanceComparisons(totalKm) {
  const km = Number(totalKm || 0);

  function setBar(barId, planeId, textId, ratio, mode) {
    // mode:
    //  - "cap1" => bar caps at 1.0 and stays full once reached
    const capped = mode === "cap1" ? Math.max(0, Math.min(1, ratio)) : ratio;
    const pct = capped * 100;

    const bar = document.getElementById(barId);
    const plane = document.getElementById(planeId);
    const text = document.getElementById(textId);
    if (!bar || !plane || !text) return;

    const completed = ratio >= 1;

    // Fill + plane position
    bar.style.width = `${pct}%`;
    plane.style.left = `${pct}%`;

    // Colour when completed
    bar.style.background = completed ? '#2e7d32' : '#ddd'; // green when done, grey otherwise

    // Text + finish flag
    const flag = completed ? ' üèÅ' : '';
    text.textContent = `${ratio.toFixed(2)}√ó${flag}`;
  }

  // Moon (cap at 1)
  const moonRatio = km / MOON_DISTANCE_KM;
  setBar('moonBar', 'moonPlane', 'moonText', moonRatio, "cap1");

  // Mars (cap at 1)
  const marsRatio = km / MARS_DISTANCE_KM;
  setBar('marsBar', 'marsPlane', 'marsText', marsRatio, "cap1");

  // Around the world (cap at 1, but show laps not "x")
  const worldLaps = km / EARTH_CIRC_KM;
  const worldPct = Math.max(0, Math.min(1, worldLaps)) * 100;

  const worldBar = document.getElementById('worldBar');
  const worldPlane = document.getElementById('worldPlane');
  const worldText = document.getElementById('worldText');

  if (worldBar && worldPlane && worldText) {
    const completed = worldLaps >= 1;
    worldBar.style.width = `${worldPct}%`;
    worldPlane.style.left = `${worldPct}%`;
    worldBar.style.background = completed ? '#2e7d32' : '#ddd';

    const flag = completed ? ' üèÅ' : '';
    worldText.textContent = `${worldLaps.toFixed(2)} laps${flag}`;
  }
}
  function computeTopMonthsByKm(rows, topN = 5) {
  const sums = new Map(); // "YYYY-MM" -> km

  for (const r of rows) {
    const d = (r.date || '').trim();        // expects YYYY-MM-DD
    const m = d.slice(0, 7);                // YYYY-MM
    if (!/^\d{4}-\d{2}$/.test(m)) continue;

    sums.set(m, (sums.get(m) || 0) + (r.distance_km || 0));
  }

  return Array.from(sums.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, topN)
    .map(([month, km]) => ({ month, km }));
}
  function computeAirportVisitDays(rows) {
  // airport -> number of distinct dates it appears (from or to)
  const seen = new Set();     // `${date}|${airport}`
  const counts = new Map();   // airport -> days

  for (const r of rows) {
    const date = (r.date || '').trim();
    if (!date) continue;

    const airports = [];
    if (r.from_iata) airports.push(r.from_iata);
    if (r.to_iata) airports.push(r.to_iata);

    for (const a of airports) {
      const airport = (a || '').trim().toUpperCase();
      if (!airport) continue;

      const key = `${date}|${airport}`;
      if (seen.has(key)) continue;

      seen.add(key);
      counts.set(airport, (counts.get(airport) || 0) + 1);
    }
  }

  return counts;
}

function radiusForVisitDays(n) {
  // bands: <5, 5‚Äì10, 11‚Äì20, 21+
  if (n >= 20) return 20;
  if (n >= 10) return 10;
  if (n >= 5) return 5;
  return 2.5;
}
  // ---------- UI ----------
  const csvUrlEl = document.getElementById('csvUrl');
  const loadBtn = document.getElementById('loadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const yearSel = document.getElementById('yearSelect');
  const airlineSel = document.getElementById('airlineSelect');
  const airportSel = document.getElementById('airportSelect');
  const airportsOnlyToggle = document.getElementById('airportsOnlyToggle');

  let allRows = [];

  function populateFilters(rows) {
    // Years
    const years = Array.from(new Set(rows.map(r => r.year).filter(y => y))).sort((a,b) => a-b);
    yearSel.innerHTML = '';

// All years option
const allYearsOpt = document.createElement('option');
allYearsOpt.value = '';
allYearsOpt.textContent = 'All years';
yearSel.appendChild(allYearsOpt);

// Individual years
for (const y of years) {
  const opt = document.createElement('option');
  opt.value = String(y);
  opt.textContent = String(y);
  yearSel.appendChild(opt);
}

    // Default to latest year
    const latest = years.length ? years[years.length - 1] : null;
    if (latest) yearSel.value = String(latest);

    // Airlines
    const airlines = Array.from(new Set(rows.map(r => (r.airline || '').trim()).filter(Boolean))).sort((a,b) => a.localeCompare(b));
    airlineSel.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = 'All airlines';
    airlineSel.appendChild(allOpt);

    for (const a of airlines) {
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      airlineSel.appendChild(opt);
    }

    yearSel.disabled = false;
    airlineSel.disabled = false;
  
  // Airports
const airportsSet = new Set();
for (const r of rows) {
  if (r.from_iata) airportsSet.add(r.from_iata);
  if (r.to_iata) airportsSet.add(r.to_iata);
}
const airports = Array.from(airportsSet).sort((a,b) => a.localeCompare(b));

airportSel.innerHTML = '';
const allAirportsOpt = document.createElement('option');
allAirportsOpt.value = '';
allAirportsOpt.textContent = 'All airports';
airportSel.appendChild(allAirportsOpt);

for (const a of airports) {
  const opt = document.createElement('option');
  opt.value = a;
  opt.textContent = a;
  airportSel.appendChild(opt);
}

airportSel.disabled = false;
}
  function applyFiltersAndRender() {
  clearLayers();
  setError('');

  const y = Number(yearSel.value || 0);
  const airline = (airlineSel.value || '').trim();
  const airport = (airportSel.value || '').trim();

  const rows = allRows.filter(r => {
    if (y && r.year !== y) return false;
    if (airline && (r.airline || '').trim() !== airline) return false;
    if (airport && r.from_iata !== airport && r.to_iata !== airport) return false;
    return true;
  });

  const airportsOnly = airportsOnlyToggle?.checked === true;
  const airportDays = computeAirportVisitDays(rows);

  // Stats
  const flights = rows.length;
  const km = Math.round(rows.reduce((acc, r) => acc + (r.distance_km || 0), 0));
  updateDistanceComparisons(km);

  const mins = rows.reduce((acc, r) => acc + (r.est_duration_min || 0), 0);
  const hours = Math.round((mins / 60) * 10) / 10;
  const days = Math.round((mins / 1440) * 10) / 10;

  const flags = computeCountryFlags(rows);
  const mentions = computeAirportMentions(rows, airport); // departures only (per your current logic)
  const airportHours = Math.round((mentions * AVG_AIRPORT_HOURS_PER_MENTION) * 10) / 10;

  document.getElementById('sFlights').textContent = flights ? fmt(flights) : '0';
  document.getElementById('sKm').textContent = km ? fmt(km) : '0';
  document.getElementById('sHours').textContent = hours ? fmt(hours) : '0';
  document.getElementById('sDays').textContent = days ? fmt(days) : '0';
  document.getElementById('sTopAirlineFlights').textContent = computeTopAirlineByFlights(rows);
  document.getElementById('sTopAirlineKm').textContent = computeTopAirlineByKm(rows);
  document.getElementById('sTopRoute').textContent = computeTopRoute(rows);
  document.getElementById('sAirports').textContent = fmt(computeUniqueAirports(rows));
  document.getElementById('sTopAirport').textContent = computeTopAirport(rows);
  document.getElementById('sAirportHours').textContent = fmt(airportHours);
  document.getElementById('flags').textContent = flags.join(' ');

  const topMonths = computeTopMonthsByKm(rows, 5);
  document.getElementById('topMonths').innerHTML =
    topMonths.length
      ? topMonths.map(x => `${x.month} ‚Äî <b>${fmt(Math.round(x.km))}</b> km`).join('<br/>')
      : '‚Äì';

  if (!rows.length) return;

  // Render
  const bounds = [];
  const airportSeen = new Set();

  for (const r of rows) {
    if (r.from_lat == null || r.from_lng == null || r.to_lat == null || r.to_lng == null) continue;

    // Routes + arrows (only if not airports-only)
    if (!airportsOnly) {
      const segments = greatCircleSegments(r.from_lat, r.from_lng, r.to_lat, r.to_lng);
      const lastSegment = segments[segments.length - 1];
      const color = getColorForAirline(r.airline);

      const popup = `
        <b>${(r.flight_no || '').toUpperCase()}</b> ${r.airline ? `(${r.airline})` : ''}<br/>
        ${r.date || ''}<br/>
        ${r.from_iata || ''} ‚Üí ${r.to_iata || ''}<br/>
        ${r.distance_km ? `${Math.round(r.distance_km)} km` : ''} ${r.est_duration_min ? `‚Ä¢ ~${Math.round(r.est_duration_min)} min` : ''}
      `;

      for (const latlngs of segments) {
        const poly = L.polyline(latlngs, {
          weight: 2,
          opacity: 0.8,
          noClip: true,
          ...(color ? { color } : {})
        }).addTo(routeLayer);

        poly.bindPopup(popup);
      }

      addArrowAtMidpoint(lastSegment, color);
    }

    // Bounds always include airports
    bounds.push([r.from_lat, r.from_lng], [r.to_lat, r.to_lng]);

  // Airport markers (dedupe)
const fromKey = `F:${r.from_iata}:${r.from_lat}:${r.from_lng}`;
const toKey   = `T:${r.to_iata}:${r.to_lat}:${r.to_lng}`;

// Decide radius based on mode
const markerRadius = airportsOnly
  ? radiusForVisitDays(
      airportDays.get((r.from_iata || '').toUpperCase()) || 1
    )
  : 1;

if (!airportSeen.has(fromKey)) {
  airportSeen.add(fromKey);

  const fromCount =
    airportDays.get((r.from_iata || '').toUpperCase()) || 1;

  L.circleMarker(
    [r.from_lat, r.from_lng],
    { radius: airportsOnly ? radiusForVisitDays(fromCount) : 1 }
  )
    .addTo(markerLayer)
    .bindPopup(
      `<b>${r.from_iata || ''}</b>${
        airportsOnly ? `<br/>Visited days: ${fromCount}` : ''
      }`
    );
}

if (!airportSeen.has(toKey)) {
  airportSeen.add(toKey);

  const toCount =
    airportDays.get((r.to_iata || '').toUpperCase()) || 1;

  L.circleMarker(
    [r.to_lat, r.to_lng],
    { radius: airportsOnly ? radiusForVisitDays(toCount) : 1 }
  )
    .addTo(markerLayer)
    .bindPopup(
      `<b>${r.to_iata || ''}</b>${
        airportsOnly ? `<br/>Visited days: ${toCount}` : ''
      }`
    );
}

  if (bounds.length) {
    map.fitBounds(bounds, { padding: [30, 30] });
  }
 } 

  function parseFlights(rawRows) {
    // Map flexible header names to expected fields
    const rows = [];
    for (const rr of rawRows) {
      const obj = {};
      for (const k in rr) obj[normKey(k)] = rr[k];

      const date = (obj['date'] ?? '').toString().trim();
      const year = parseYear(date);

      const flight_no = (obj['flight_no'] ?? obj['flight'] ?? '').toString().trim();
      const airline = (obj['airline'] ?? '').toString().trim();
      const from_iata = (obj['from_iata'] ?? obj['from'] ?? '').toString().trim().toUpperCase();
      const to_iata = (obj['to_iata'] ?? obj['to'] ?? '').toString().trim().toUpperCase();

      const from_lat = num(obj['from_lat']);
      const from_lng = num(obj['from_lng']);
      const to_lat = num(obj['to_lat']);
      const to_lng = num(obj['to_lng']);

      const distance_km = num(obj['distance_km']);
      const est_duration_min = num(obj['est_duration_min']);
      const from_country_code = (obj['from_country_code'] ?? '').toString().trim().toUpperCase();
const to_country_code   = (obj['to_country_code'] ?? '').toString().trim().toUpperCase();

      // Skip blank rows
      if (!date && !flight_no && !from_iata && !to_iata) continue;

      rows.push({
        date, year,
        flight_no, airline,
        from_iata, to_iata,from_country_code, to_country_code,
        from_lat, from_lng, to_lat, to_lng,
        distance_km: distance_km || 0,
        est_duration_min: est_duration_min || 0,
        route: (obj['route'] ?? '').toString().trim()
      });
    }
    return rows.filter(r => r.year); // keep rows with valid year for filtering
  }

  function loadCsv() {
    setError('');
    clearLayers();

    const url = csvUrlEl.value.trim();
    if (!url || url.includes('PASTE_YOUR_PUBLISHED_CSV_URL_HERE')) {
      setError('Paste your published Google Sheets CSV URL first.');
      return;
    }

    Papa.parse(url, {
  download: true,
  header: true,
  skipEmptyLines: true,
  delimitersToGuess: [",", "\t", ";", "|"],
  complete: (results) => {
        try {
          const parsed = parseFlights(results.data || []);
          if (!parsed.length) {
            setError('No rows found (or missing required columns). Check your published sheet and headers.');
            return;
          }
          allRows = parsed;
          populateFilters(allRows);

          // Default: latest year (already selected), all airlines
          applyFiltersAndRender();
        } catch (e) {
          setError('Failed to parse flights:\n' + (e?.message || e));
        }
      },
      error: (err) => setError('CSV load error:\n' + (err?.message || err))
    });
  }

  loadBtn.addEventListener('click', loadCsv);
  resetBtn.addEventListener('click', resetView);
  yearSel.addEventListener('change', applyFiltersAndRender);
  airlineSel.addEventListener('change', applyFiltersAndRender);
  airportSel.addEventListener('change', applyFiltersAndRender);
  airportsOnlyToggle.addEventListener('change', applyFiltersAndRender);

  // Try loading immediately if a URL is already pasted
  // (Handy once you‚Äôve set it up.)
  // Comment out if you prefer manual load.
  // loadCsv();
</script>
</body>
</html>
